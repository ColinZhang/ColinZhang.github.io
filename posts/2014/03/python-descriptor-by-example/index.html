<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Python Descriptor by Example</title>
  <meta name="author" content="Fan">



  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">

  <link href="/favicon.ico" rel="icon">
  <link href="/theme/css/main.css" media="screen" rel="stylesheet" type="text/css">
  <link href="//brick.a.ssl.fastly.net/Lato:400" rel="stylesheet" >
  <script src="/theme/js/jquery-1.11.1.min.js"></script>
  <script src="/theme/js/modernizr-2.0.js"></script>
  <script src="/theme/js/ender.js"></script>
  <script src="/theme/js/octopress.js" type="text/javascript"></script>
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
</head>

<body>
  <header role="banner"><div id="logo"></div>
<h1><a href="/">bl4ck5un</a></h1>
  <h2>Less is more</h2>
</header>
  <nav role="navigation"><ul class="main-navigation">
    <li><a href="/index.html">["home"]</a></li>
    <li><a href="/category/blogs.html">["blogs"]</a></li>
    <li><a href="/pages/about.html">["about"]</a></li>
    <li><a href="/archives.html">["archive"]</a></li>
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
    <h1 class="entry-title">Python Descriptor by Example</h1>
</header>

<p class="meta-up">
<span class="byline author vcard">
Posted by <span class="fn">Fan</span>
</span>
<time datetime="2014-03-12T00:00:00" pubdate>2014-03-12</time><span class="categories">
<i class="fa fa-tags"></i>
<a class="category" href="/tag/python.html">Python</a>
<a class="category" href="/tag/python-descriptor.html">Python descriptor</a>
</span>
</p>
<div class="entry-content">
    <!-- reuse summary -->
    <p class="first last">Understand how to write and take advantage of Python descriptor by looking into product
example from Django source code.</p>

    <p>When browsing the source code of OSQA, I accidentally dipped into Django's implementation of <cite>AuthenticationMiddleware</cite>,
the middleware attaching <cite>user</cite> instance to each <cite>request</cite> when hooked within <cite>process_request</cite>.
Following live code from Django 1.3 could be a great illustration on how descriptor works and what makes it agile.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">LazyUser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">obj_type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;_cached_user&#39;</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">get_user</span>
            <span class="n">request</span><span class="o">.</span><span class="n">_cached_user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">_cached_user</span>

<span class="k">class</span> <span class="nc">AuthenticationMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;session&#39;</span><span class="p">),</span> <span class="s">&quot;blah balh&quot;</span>
        <span class="n">request</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">LazyUser</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></div>
</td></tr></table><div class="section" id="so-firstly-what-is-a-descriptor">
<h2>So, firstly, what is a <cite>descriptor</cite></h2>
<p>Abstract and vague as the official documentation is, if you read it with more concrete experience,
you'd find it's not that bad actually.</p>
<p>&gt;The following methods only apply when an instance of the class containing the method (a so-called <strong>descriptor class</strong>) appears in the class dictionary of another new-style class, known as the <strong>owner class</strong>.</p>
<p><strong>&quot;following methods&quot;</strong> refers to</p>
<ul class="simple">
<li><cite>object.__get__(self, instance, owner)</cite> Called to get the attribute of the owner class (class attribute access) or of an instance of that class (instance attribute access). <cite>Owner</cite> is always the owner class, while <cite>instance</cite> is the instance that the attribute was accessed through, or <cite>None</cite> when the attribute is accessed through the owner. This method should return the (computed) attribute value or raise an AttributeError exception.</li>
<li><cite>object.__set__(self, instance, value)</cite> Called to set the attribute on an instance instance of the owner class to a new value.</li>
<li><cite>object.__delete__(self, instance)</cite> Called to delete the attribute on an instance instance of the owner class.</li>
</ul>
</div>
<div class="section" id="now-let-s-look-into-the-fresh-code">
<h2>Now let's look into the fresh code</h2>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">LazyUser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; LazyUser is a descriptor class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">obj_type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;_cached_user&#39;</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">get_user</span>
            <span class="n">request</span><span class="o">.</span><span class="n">_cached_user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">_cached_user</span>

<span class="k">class</span> <span class="nc">AuthenticationMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;session&#39;</span><span class="p">),</span> <span class="s">&quot;blah balh&quot;</span>
        <span class="c"># request.__class__ is the *owner class*</span>
        <span class="c"># request.__class__.user refers to the *instance* of LazyUser</span>
        <span class="n">request</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">LazyUser</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></div>
</td></tr></table><p>Technically speaking, with <cite>__get__</cite> method defined, <cite>class LazyUser</cite> becomes a descriptor class and then gets assigned to <cite>request.__class__</cite> by hook method in <cite>AuthenticationMiddleware</cite>. After that <cite>request.__class__</cite> becomes the counterpart -- <strong>owner</strong> class.</p>
</div>
<div class="section" id="why-called-lazy">
<h2>Why called lazy?</h2>
<p>By now, we've inspected every cover of the code. However, nothing concrete has actually happened yet, all of this has nothing to do with the real <cite>User</cite> object (store in session) by now. In other words, the actual access to <cite>User</cite> object has been postponed as much as possible, until <cite>request.user</cite> attributed is queried (then <cite>__get__(...)</cite> executes and return a meaningful user object from session, but the detail is not important to current topic). That's where the name <em>LazyUser</em> comes from.</p>
</div>
<div class="section" id="a-closer-look">
<h2>A closer look</h2>
<p>Let's take a closer look at the parameters of <cite>__get__</cite> method:</p>
<dl class="docutils">
<dt>..code-block:: python</dt>
<dd>def __get__(self, request, obj_type=None):</dd>
</dl>
<p>Note that, corresponding to documentation, <cite>object.__get__(self, instance, owner)</cite>, we can find <cite>instance</cite> is used instead of <cite>owner</cite>. Here in our live example, <cite>request</cite> is the <em>instance</em> of owner class (<cite>request.__class__</cite>).</p>
</div>

</div>
    <footer>
      <p class="meta">
<span class="byline author vcard">
Posted by <span class="fn">Fan</span>
</span>
<time datetime="2014-03-12T00:00:00" pubdate>2014-03-12</time><span class="categories">
<i class="fa fa-tags"></i>
<a class="category" href="/tag/python.html">Python</a>
<a class="category" href="/tag/python-descriptor.html">Python descriptor</a>
</span>
      </p>
<div class="sharing">
</div>    </footer>
  </article>

</div>
      <!--<aside class="sidebar">
<section class="aside-about">
    <div class="avatar"></div>
    <span class="aside-name">Fan Zhang</span>
    <ul class="sns">
            <li><a href="https://github.com/cmade" title="Fork me on Github"><i class="fa fa-github-alt fa-2x"></i></a></li>
            <li><a href="http://www.linkedin.com/profile/view?id={who}" title="LinkedIn"><i class="fa fa-linkedin-square fa-2x"></i></a></li>
            <li><a href="https://plus.google.com/{who}" title="Plus me"><i class="fa fa-google-plus-square fa-2x"></i></a></li>
            <li><a href="mailto:colin.zhang1992@gmail.com" title="Write to me"><i class="fa fa-envelope fa-2x"></i></a></li>
    </ul>
    <div class="spacer"></div>
</section>    <section>
        <h1>Recent Posts</h1>
        <ul id="recent_posts">
            <li class="post">
                <a href="/posts/2014/04/CVE-2013-1763/">CVE-2013-1763</a>
            </li>
            <li class="post">
                <a href="/posts/2014/04/CVE-2014-0038/">CVE-2014-0038</a>
            </li>
            <li class="post">
                <a href="/posts/2014/04/why-heart-bleeds/">Why Heart Bleeds</a>
            </li>
            <li class="post">
                <a href="/posts/2014/03/python-descriptor-by-example/">Python Descriptor by Example</a>
            </li>
            <li class="post">
                <a href="/posts/2014/02/quotation-concept-in-unix-shell/">Quotation concept in Unix Shell</a>
            </li>
        </ul>
    </section>
    <section>

    <h1>Categories</h1>
    <ul id="recent_posts">
        <li><a href="/category/blogs.html">blogs</a></li>
    </ul>
</section>

<section>
    <h1>Tags</h1>
    <a href="/tag/shell.html">Shell</a>,    <a href="/tag/networking.html">Networking</a>,    <a href="/tag/socket.html">Socket</a>,    <a href="/tag/ssl.html">SSL</a>,    <a href="/tag/python.html">Python</a>,    <a href="/tag/python-descriptor.html">Python descriptor</a>,    <a href="/tag/security.html">Security</a></section>



</aside>-->
    </div>
  </div>
  <footer role="contentinfo"><p>
      Copyright &copy; 2014 - Fan -
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
</body>
</html>